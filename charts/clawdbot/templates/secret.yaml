{{- $secretName := include "clawdbot.fullname" . -}}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $secretName -}}
{{- $token := "" -}}
{{- $configToken := include "clawdbot.gatewayAuthToken" . | trim -}}
{{- if $configToken }}
{{- $token = $configToken -}}
{{- else if $existing }}
{{- $token = (index $existing.data "gatewayToken") | b64dec -}}
{{- else }}
{{- $token = randAlphaNum 64 -}}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "clawdbot.labels" . | nindent 4 }}
type: Opaque
stringData:
  gatewayToken: {{ $token | quote }}
  clawdbot.json: |-
{{ include "clawdbot.configJson" . | nindent 4 }}
