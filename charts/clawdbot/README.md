# Clawdbot Helm chart

This chart deploys the Clawdbot gateway as a single replica with persistent state and workspace volumes.

## Install

```bash
helm install clawdbot clawdbot \
  --set image.repository=clawdbot/clawdbot \
  --set image.tag=2026.1.5-3
```

## Configuration

Clawdbot reads JSON5 config from `/config/clawdbot.json`. The chart renders `.Values.config` into a Secret
and copies it into a writable `emptyDir` at startup. The gateway can update the file at runtime, but it is
overwritten from Helm values on every pod start. Update the config by editing your values file and upgrading.

Example `values.yaml` override:

```yaml
config: |-
  {
    agent: {
      workspace: "/home/node/clawd",
      sandbox: {
        mode: "non-main",
        docker: {
          image: "registry.example.com/clawdbot-sandbox:bookworm-slim"
        },
        browser: {
          enabled: true,
          image: "registry.example.com/clawdbot-sandbox-browser:bookworm-slim"
        }
      }
    },
    gateway: { bind: "lan", auth: { mode: "token" } },
    whatsapp: { allowFrom: ["+15555550123"] }
  }
```

The gateway auth token is generated by Helm on first install and stored in the same Secret. By default the
Secret name is the chart fullname:
- If the release name already contains `clawdbot` (example: release `clawdbot`), the Secret is `clawdbot`.
- Otherwise it is `<release>-clawdbot`.
To retrieve it:

```bash
kubectl get secret clawdbot -o jsonpath='{.data.gatewayToken}' | base64 -d
```

## Persistence

Two PVCs are created by default:
- State: `~/.clawdbot`
- Workspace: `~/clawd`

Override sizes and storage classes under `persistence.*`.

## Docker-in-Docker sandbox (optional)

The gateway uses the Docker CLI for `agent.sandbox`. In Kubernetes, that means:
- your gateway image must include the `docker` client
- a Docker daemon must be reachable at `/var/run/docker.sock`
- the sandbox images must be pullable by the daemon

This chart can run a privileged DinD sidecar to provide the socket:

```yaml
dind:
  enabled: true
  image:
    repository: docker
    tag: "29.1.3-dind"
  storage:
    type: emptyDir

config: |-
  {
    agent: {
      sandbox: {
        mode: "non-main",
        docker: {
          image: "my-registry/clawdbot-sandbox:bookworm-slim"
        }
      }
    }
  }
```

To pre-pull images into the DinD daemon on startup:

```yaml
dind:
  enabled: true
  prePull:
    enabled: true
    images:
      - "registry.example.com/clawdbot-sandbox:bookworm-slim"
      - "registry.example.com/clawdbot-sandbox-browser:bookworm-slim"
```

Notes:
- DinD requires `privileged: true` in the pod security context.
- If you use a private registry, supply a dockerconfigjson secret and enable registry auth.
- `dind.prePull` waits for dockerd and fails the pod if any image pull fails.
- Consider NetworkPolicy to prevent access to the Docker API from other pods.

## Browser deployment (remote CDP, optional)

You can run a dedicated Chromium pod and point the gateway at its CDP endpoint.
When enabled, the chart automatically injects `browser.cdpUrl` (and `browser.attachOnly: true`)
into the rendered config **if** you have not already set them in `config`.

```yaml
browserDeployment:
  enabled: true
  image:
    repository: "registry.example.com/clawdbot-sandbox-browser"
    tag: "bookworm-slim"
  persistence:
    enabled: true

config:
  browser:
    enabled: true
```

Notes:
- The Service name is `<release>-clawdbot-browser` (or `<release>-<nameOverride>-browser`).
- The Service port defaults to `browserDeployment.port` (default `9222`).
- If you set `config.browser.cdpUrl` yourself, the chart will not override it.
- To disable, set `browserDeployment.enabled: false` (default).

## Registry credentials (gateway + sandbox images)

This chart can mount a `kubernetes.io/dockerconfigjson` secret into the gateway
container and use it for both gateway image pulls and sandbox image pulls. When
DinD is enabled, the secret is also mounted into the dind container for pre-pull
auth.

```yaml
registryAuth:
  enabled: true
  secretName: clawdbot-registry
  useForImagePull: true

config: |-
  {
    agent: {
      sandbox: {
        mode: "non-main",
        docker: { image: "registry.example.com/clawdbot-sandbox:bookworm-slim" },
        browser: {
          enabled: true,
          image: "registry.example.com/clawdbot-sandbox-browser:bookworm-slim"
        }
      }
    }
  }
```

Create the secret with:

```bash
kubectl create secret docker-registry clawdbot-registry \
  --docker-server=registry.example.com \
  --docker-username="$REGISTRY_USER" \
  --docker-password="$REGISTRY_PASS"
```

## Bridge port

If you need the node bridge (iOS/Android), enable both:
- `service.bridge.enabled: true`
- `bridge.enabled: true` in the JSON5 config

The bridge default port is `18790`.

## Ingress

Enable `ingress.enabled` to expose the gateway/control UI over HTTP(S). The gateway WebSocket and UI share
the same port (`18789`).

The service port defaults to `gateway.port`. Override `service.port` if you need a different external port.
