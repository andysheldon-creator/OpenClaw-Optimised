upstream n8n {
    server n8n:5678;
}

upstream dashboard {
    server dashboard:5174;
}

upstream openclaw_gateway {
    server openclaw-gateway:18789;
}

map $http_upgrade $connection_upgrade {
    default upgrade;
    "" close;
}

server {
    listen 80;
    server_name _;
    client_max_body_size 50M;

    # Dashboard workflow editor route — longer prefix wins over /workflows
    # so the dashboard SPA handles /workflows/editor, /workflows/catalog, etc.
    location /workflows/editor {
        proxy_pass http://dashboard;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_set_header Accept-Encoding "";
        sub_filter_once on;
        sub_filter_types text/html;
        sub_filter '</head>' '<script>try{var k="openclaw.dashboard.gateway";if(!localStorage.getItem(k)){localStorage.setItem(k,JSON.stringify({url:"ws://"+location.host+"/gateway/ws",token:"dev-local-token"}))}}catch(e){}</script></head>';
    }

    location /workflows/catalog {
        proxy_pass http://dashboard;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_set_header Accept-Encoding "";
        sub_filter_once on;
        sub_filter_types text/html;
        sub_filter '</head>' '<script>try{var k="openclaw.dashboard.gateway";if(!localStorage.getItem(k)){localStorage.setItem(k,JSON.stringify({url:"ws://"+location.host+"/gateway/ws",token:"dev-local-token"}))}}catch(e){}</script></head>';
    }

    # n8n workflows endpoint with WebSocket support
    # Use /workflows (no trailing slash) so the prefix match also covers
    # asset paths n8n emits as /workflowsassets/... (missing separator).
    location /workflows {
        # n8n sets BASE_PATH=/workflows and concatenates it with sub-paths
        # (rest/, assets/, static/, push/) WITHOUT a separator, producing
        # /workflowsrest/..., /workflowsassets/..., etc.  n8n actually serves
        # these resources at the root (/rest/, /assets/, ...).
        # Strip the /workflows prefix when it's NOT followed by a slash.
        rewrite ^/workflows(?!/)(.+)$ /$1 break;

        proxy_pass http://n8n;
        proxy_http_version 1.1;

        # WebSocket headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for long-lived connections
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }

    # Chat UI — gateway's built-in Control UI with full chat interface.
    # The gateway serves it at controlUi.basePath = /chat.
    # WS connection is pre-configured via sub_filter to use /gateway/ws.
    location /chat {
        proxy_pass http://openclaw_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Inject gateway connection config so the Control UI auto-connects.
        proxy_set_header Accept-Encoding "";
        sub_filter_once on;
        sub_filter_types text/html;
        sub_filter '</head>' '<script>try{var k="openclaw.control.settings.v1";if(!localStorage.getItem(k)){localStorage.setItem(k,JSON.stringify({gatewayUrl:"ws://"+location.host+"/gateway/ws",token:"dev-local-token"}))}}catch(e){}</script></head>';

        proxy_read_timeout 600s;
    }

    # Gateway WebSocket tunnel for dashboard RPC
    location /gateway/ws {
        proxy_pass http://openclaw_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Optional HTTP passthrough for gateway endpoints
    location /gateway/ {
        rewrite ^/gateway/(.*)$ /$1 break;
        proxy_pass http://openclaw_gateway;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Root endpoint routes to dashboard
    location / {
        proxy_pass http://dashboard;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Inject gateway connection config so the dashboard auto-connects
        # with the dev token on first load (only sets if localStorage is empty).
        proxy_set_header Accept-Encoding "";
        sub_filter_once on;
        sub_filter_types text/html;
        sub_filter '</head>' '<script>try{var k="openclaw.dashboard.gateway";if(!localStorage.getItem(k)){localStorage.setItem(k,JSON.stringify({url:"ws://"+location.host+"/gateway/ws",token:"dev-local-token"}))}}catch(e){}</script></head>';
    }

    # Health check endpoint
    location /health {
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
