<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OpenClaw Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.5.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.5.0/lib/xterm.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style type="text/tailwindcss">
      @theme {
        --font-sans: "Space Grotesk", ui-sans-serif, system-ui, -apple-system, sans-serif;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }
      #terminal-container {
        width: 100%;
        height: calc(100% - 60px);
      }
    </style>
  </head>
  <body class="bg-neutral-950 text-neutral-100 font-sans">
    <div
      class="bg-neutral-900 border-b border-neutral-800 px-4 py-3 flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <picture>
          <img
            src="https://raw.githubusercontent.com/openclaw/openclaw/main/docs/assets/openclaw-logo-text.png"
            alt="OpenClaw"
            class="h-6"
          />
        </picture>
        <span class="text-sm text-neutral-400">Terminal</span>
      </div>
      <div class="flex items-center gap-2">
        <span id="status" class="text-sm text-amber-500">Connecting...</span>
      </div>
    </div>
    <div id="terminal-container"></div>
    <script>
      const term = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        fontFamily: 'Menlo, Monaco, "Courier New", monospace',
        theme: {
          background: "#0a0a0a",
          foreground: "#e5e5e5",
          cursor: "#ef4444",
          black: "#171717",
          red: "#ef4444",
          green: "#10b981",
          yellow: "#f59e0b",
          blue: "#3b82f6",
          magenta: "#a855f7",
          cyan: "#06b6d4",
          white: "#e5e5e5",
          brightBlack: "#404040",
          brightRed: "#f87171",
          brightGreen: "#34d399",
          brightYellow: "#fbbf24",
          brightBlue: "#60a5fa",
          brightMagenta: "#c084fc",
          brightCyan: "#22d3ee",
          brightWhite: "#f5f5f5",
        },
      });

      term.open(document.getElementById("terminal-container"));

      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const ws = new WebSocket(`${protocol}//${window.location.host}/tui/ws`);
      const statusEl = document.getElementById("status");
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 3;

      ws.onopen = () => {
        statusEl.textContent = "Connected";
        statusEl.className = "text-sm text-emerald-500";
        reconnectAttempts = 0;

        const fitAddon = { _lastCols: null, _lastRows: null };
        function sendResize() {
          const cols = term.cols;
          const rows = term.rows;
          if (cols !== fitAddon._lastCols || rows !== fitAddon._lastRows) {
            ws.send(JSON.stringify({ type: "resize", cols, rows }));
            fitAddon._lastCols = cols;
            fitAddon._lastRows = rows;
          }
        }

        function fitTerminal() {
          const container = document.getElementById("terminal-container");
          const width = container.clientWidth;
          const height = container.clientHeight;
          const cols = Math.floor(width / 9);
          const rows = Math.floor(height / 18);
          term.resize(cols, rows);
          sendResize();
        }

        fitTerminal();
        window.addEventListener("resize", fitTerminal);

        term.onData((data) => {
          ws.send(JSON.stringify({ type: "input", data }));
        });
      };

      ws.onmessage = (event) => {
        term.write(event.data);
      };

      ws.onerror = (err) => {
        console.error("WebSocket error:", err);
        statusEl.textContent = "Connection error";
        statusEl.className = "text-sm text-red-500";
      };

      ws.onclose = (event) => {
        statusEl.textContent = "Disconnected";
        statusEl.className = "text-sm text-red-500";

        if (event.code === 4001) {
          term.writeln("\r\n\x1b[31mAnother session is already active.\x1b[0m");
        } else if (event.code === 4002) {
          term.writeln("\r\n\x1b[33mSession expired due to inactivity.\x1b[0m");
        } else if (event.code === 4003) {
          term.writeln("\r\n\x1b[31mWeb TUI is not enabled on this server.\x1b[0m");
        } else if (event.code === 1008) {
          term.writeln("\r\n\x1b[31mAuthentication required.\x1b[0m");
        } else if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
          term.writeln(
            `\r\n\x1b[33mReconnecting in ${delay / 1000}s... (attempt ${reconnectAttempts}/${maxReconnectAttempts})\x1b[0m`,
          );
          setTimeout(() => {
            window.location.reload();
          }, delay);
        } else {
          term.writeln("\r\n\x1b[31mConnection closed. Please refresh to reconnect.\x1b[0m");
        }
      };
    </script>
  </body>
</html>
