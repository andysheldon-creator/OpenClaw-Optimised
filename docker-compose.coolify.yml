services:
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - OPENCLAW_BETA=${OPENCLAW_BETA:-false}

    environment:
      # Required settings
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}
      - ZAI_API_KEY=${ZAI_API_KEY:-PLACEHOLDER_KEY}

      # Optional with defaults
      - OPENCLAW_GATEWAY_PORT=${OPENCLAW_GATEWAY_PORT:-28471}
      - OPENCLAW_GATEWAY_BIND=${OPENCLAW_GATEWAY_BIND:-lan}
      - NODE_ENV=production
      - HOME=/root
      - TERM=xterm-256color
      - OPENCLAW_STATE_DIR=/root/.openclaw
      - OPENCLAW_WORKSPACE=/root/openclaw-workspace

      # Auto-bootstrap and configuration
      - OPENCLAW_AUTO_BOOTSTRAP=1
      - OPENCLAW_PRINT_ACCESS=1
      - GATEWAY_TRUSTED_PROXIES=*
      
      # Fix for file watching in Docker
      - CHOKIDAR_USEPOLLING=true
      
      # Command history persistence
      - HISTFILE=/root/.openclaw/.bash_history
      - HISTSIZE=50000
      - HISTSAVE=50000
      - HISTCONTROL=ignoreboth

      # Node memory limit
      - NODE_OPTIONS=--max-old-space-size=4096

    volumes:
      - openclaw-config:/root/.openclaw
      - openclaw-workspace:/root/openclaw-workspace

    # NOTE: Running as root due to Coolify volume permission behavior.
    # See: https://github.com/coollabsio/coolify/issues/2873
    user: "0"

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # File descriptor limits
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

    # Healthcheck using HTTP
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${OPENCLAW_GATEWAY_PORT:-28471}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    # Resources (8GB RAM / 2 vCPU)
    deploy:
      resources:
        limits:
          memory: 6G
          cpus: '1.8'
        reservations:
          memory: 2G
          cpus: '0.5'
      restart_policy:
        condition: unless-stopped
        delay: 5s

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

    # Network
    expose:
      - "${OPENCLAW_GATEWAY_PORT:-28471}"

    init: true
    stop_grace_period: 30s

    # Use external bootstrap script
    command: ["bash", "/app/scripts/coolify-bootstrap.sh"]

    depends_on:
      - docker-proxy

  # Docker Socket Proxy for secure sandboxing
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      LOG_LEVEL: info
      # Security: Only enable necessary Docker APIs
      POST: 1       # Create containers
      CONTAINERS: 1 # List/manage containers
      IMAGES: 1     # Pull images
      NETWORKS: 1   # Connect to networks
      INFO: 1       # Version check
      VERSION: 1
      EXEC: 1       # Run commands (exec)
      EVENTS: 1     # Listen for events

volumes:
  openclaw-config:
  openclaw-workspace:
